name: Daily regression test

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  test-edge-tts:
    runs-on: ubuntu-latest
    name: test edge tts generation

    steps:
      - uses: actions/checkout@v4

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: install poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: install dependencies
        run: |
          poetry install --with test

      - name: test edge tts audio generation
        run: |
          poetry run python -m pytest tests/test_voicegenhub.py::TestVoiceGenHub::test_edge_tts_generation -v --cov=src/voicegenhub --cov-report=xml

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage.xml


      - name: send edge tts failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "voicegenhub edge tts nightly test failed"
          body: |
            the edge tts nightly test failed in voicegenhub repository.

            note: if this is due to microsoft api 401/403 errors, the provider has been
            updated with retry logic and graceful degradation to prevent downstream
            project outages. the test failure is informational.

            workflow: ${{ github.workflow }}
            run: ${{ github.run_number }}
            commit: ${{ github.sha }}

            please check the workflow logs at:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.SMTP_USERNAME }}
          from: voicegenhub nightly tests <${{ secrets.SMTP_USERNAME }}>

      - name: upload failure logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: edge-tts-failure-logs
          path: |
            *.log
            /tmp/*.log

  test-google-tts:
    runs-on: ubuntu-latest
    name: test google tts generation

    steps:
      - uses: actions/checkout@v4

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: install poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: install dependencies
        run: |
          poetry install --with test

      - name: test google tts audio generation
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
        run: |
          if [ -z "$GOOGLE_APPLICATION_CREDENTIALS_JSON" ]; then
            echo "ERROR: GOOGLE_APPLICATION_CREDENTIALS_JSON secret not configured"
            echo "Google TTS test requires Google Cloud credentials to be set up"
            echo "Please add the GOOGLE_APPLICATION_CREDENTIALS_JSON secret in repository settings"
            exit 1
          fi

          echo "Setting up Google Cloud credentials..."
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/google-credentials.json
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/google-credentials.json"

          echo "Running Google TTS test..."
          poetry run python -m pytest tests/test_voicegenhub.py::TestVoiceGenHub::test_google_tts_generation -v --cov=src/voicegenhub --cov-report=xml --cov-append

      - name: Upload Google TTS coverage to artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-google
          path: coverage.xml

      - name: send google tts failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "voicegenhub google tts nightly test failed"
          body: |
            the google tts nightly test failed in voicegenhub repository.

            workflow: ${{ github.workflow }}
            run: ${{ github.run_number }}
            commit: ${{ github.sha }}

            please check the workflow logs at:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.SMTP_USERNAME }}
          from: voicegenhub nightly tests <${{ secrets.SMTP_USERNAME }}>

      - name: upload failure logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: google-tts-failure-logs
          path: |
            *.log
            /tmp/*.log

  test-piper-tts:
    runs-on: ubuntu-latest
    name: test piper tts generation

    steps:
      - uses: actions/checkout@v4

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: install poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: install dependencies
        run: |
          poetry install --with test,piper

      - name: test piper tts audio generation
        run: |
          poetry run python -m pytest tests/test_voicegenhub.py::TestVoiceGenHub::test_piper_tts_generation -v --cov=src/voicegenhub --cov-report=xml

      - name: send piper tts failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "voicegenhub piper tts nightly test failed - WINDOWS WARNING"
          body: |
            the piper tts nightly test failed in voicegenhub repository.

            WARNING: Piper TTS has known compatibility issues on Windows due to ONNX Runtime DLL loading failures.
            On Windows, this provider gracefully disables itself and logs appropriate warnings.
            Linux and macOS: Full neural TTS support with excellent quality.

            workflow: ${{ github.workflow }}
            run: ${{ github.run_number }}
            commit: ${{ github.sha }}

            please check the workflow logs at:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.SMTP_USERNAME }}
          from: voicegenhub nightly tests <${{ secrets.SMTP_USERNAME }}>

  test-coqui-tts:
    runs-on: ubuntu-latest
    name: test coqui tts generation

    steps:
      - uses: actions/checkout@v4

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: install poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: install dependencies
        run: |
          poetry install --with test,coqui

      - name: test coqui tts audio generation
        run: |
          poetry run python -m pytest tests/test_voicegenhub.py::TestVoiceGenHub::test_coqui_tts_generation -v --cov=src/voicegenhub --cov-report=xml

      - name: send coqui tts failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "voicegenhub coqui tts nightly test failed - WINDOWS WARNING"
          body: |
            the coqui tts nightly test failed in voicegenhub repository.

            WARNING: Coqui TTS requires Microsoft Visual C++ Build Tools on Windows for compilation.
            On Windows, this provider gracefully disables itself and logs appropriate installation instructions.
            Linux and macOS: Full neural TTS support with state-of-the-art models.

            workflow: ${{ github.workflow }}
            run: ${{ github.run_number }}
            commit: ${{ github.sha }}

            please check the workflow logs at:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.SMTP_USERNAME }}
          from: voicegenhub nightly tests <${{ secrets.SMTP_USERNAME }}>

  upload-coverage:
    runs-on: ubuntu-latest
    needs: [test-edge-tts, test-google-tts, test-piper-tts, test-coqui-tts]
    steps:
      - uses: actions/checkout@v4

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-reports*
          merge-multiple: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
