name: Daily regression test

on:
  schedule:
    - cron: '0 2 * * *'  # Run at 2 AM UTC daily
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-edge-tts:
    runs-on: ubuntu-latest
    name: test edge tts generation
    
    steps:
      - uses: actions/checkout@v4
      
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: install dependencies
        run: |
          pip install -e .
          
      - name: test edge tts audio generation
        run: |
          python -c "
          import asyncio
          from voicegenhub import VoiceGenHub
          
          async def test():
              tts = VoiceGenHub()
              await tts.initialize()
              
              response = await tts.generate(
                  text='nightly test of edge tts provider',
                  voice='en-US-AriaNeural'
              )
              
              assert len(response.audio_data) > 0, 'no audio data generated'
              assert response.duration > 0, 'invalid audio duration'
              
              print(f'success: generated {len(response.audio_data)} bytes, {response.duration:.2f}s duration')
          
          asyncio.run(test())
          "
          
      - name: send edge tts failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "voicegenhub edge tts nightly test failed"
          body: |
            the edge tts nightly test failed in voicegenhub repository.
            
            workflow: ${{ github.workflow }}
            run: ${{ github.run_number }}
            commit: ${{ github.sha }}
            
            please check the workflow logs at:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.SMTP_USERNAME }}
          from: voicegenhub nightly tests <${{ secrets.SMTP_USERNAME }}>
          
      - name: upload failure logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: edge-tts-failure-logs
          path: |
            *.log
            /tmp/*.log

  test-google-tts:
    runs-on: ubuntu-latest
    name: test google tts generation
    
    steps:
      - uses: actions/checkout@v4
      
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: install dependencies
        run: |
          pip install -e .
          pip install google-cloud-texttospeech
          
      - name: test google tts audio generation
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
        run: |
          if [ -z "$GOOGLE_APPLICATION_CREDENTIALS_JSON" ]; then
            echo "skipping google tts test - no credentials configured"
            exit 0
          fi
          
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/google-credentials.json
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/google-credentials.json"
          
          python -c "
          import asyncio
          from voicegenhub import VoiceGenHub
          
          async def test():
              try:
                  tts = VoiceGenHub()
                  await tts.initialize()
                  
                  # Try to create google provider
                  from voicegenhub.providers.factory import provider_factory
                  await provider_factory.discover_and_register_providers()
                  google_provider = await provider_factory.create_provider('google')
                  
                  # Test with google provider
                  response = await google_provider.synthesize({
                      'text': 'nightly test of google tts provider',
                      'voice_id': 'en-US-Standard-A',
                      'language': 'en-US'
                  })
                  
                  assert len(response.audio_data) > 0, 'no audio data generated'
                  assert response.duration > 0, 'invalid audio duration'
                  
                  print(f'success: generated {len(response.audio_data)} bytes, {response.duration:.2f}s duration')
                  
              except Exception as e:
                  print(f'google tts test failed: {e}')
                  raise
          
          asyncio.run(test())
          "
          
      - name: send google tts failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "voicegenhub google tts nightly test failed"
          body: |
            the google tts nightly test failed in voicegenhub repository.
            
            workflow: ${{ github.workflow }}
            run: ${{ github.run_number }}
            commit: ${{ github.sha }}
            
            please check the workflow logs at:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.SMTP_USERNAME }}
          from: voicegenhub nightly tests <${{ secrets.SMTP_USERNAME }}>
          
      - name: upload failure logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: google-tts-failure-logs
          path: |
            *.log
            /tmp/*.log